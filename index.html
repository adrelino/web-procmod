<html>
	<head>
		<title>Procedural Modeling</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
		<!-- <link rel="stylesheet" href="lib/codemirror/codemirror.css"> -->
		<!-- <script src="lib/codemirror/codemirror-compressed.js"></script> -->
		<script src="lib/jquery-2.1.3.min.js"></script>
		<script src="lib/three/three.min.js"></script>
		<script src="lib/three/OrbitControls.js"></script>
		<script src="lib/dat.gui.min.js"></script>
		<script src="../webppl/compiled/webppl.min.js"></script>
		<script src="geometry.js"></script>
	</head>
	<body>
<!-- 		<div>
			<textarea id="code">
				// This is a comment!
			</textarea>
		</div> -->
		<script>
			var scene, camera, renderer, controls, gui, settings;
			var compiledCode, topK, _trampoline;
			var model = null;

			function animate() 
			{
				requestAnimationFrame(animate);
				controls.update();
			}

			function render()
			{
				renderer.render(scene, camera);
			}

			function onWindowResize()
			{
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize(window.innerWidth, window.innerHeight);
				render();
			}

			function webppl_compile(code)
			{
				var geometry;
				compiledCode = webppl.compile("(function(){" + code + "})()");
				webppl_generate();
			}

			function webppl_generate()
			{
				topK = function(store, samps)
				{
					_trampoline = null;

					var bestsamp = null;
					var bestscore = -Infinity;
					for (var i = 0; i < samps.length; i++)
					{
						var entry = samps[i];
						if (entry.prob > bestscore)
						{
							bestscore = entry.prob;
							bestsamp = entry.val;
						} 
					}
					// var geometry = bestsamp;
					var geometry = bestsamp.toThreeGeo();

					var materials = [
						new THREE.MeshLambertMaterial({ color: new THREE.Color(.9, .9, .9).getHex(), shading: THREE.FlatShading, polygonOffset: true, polygonOffsetFactor: 1, polygonOffsetUnits: 1 }),
						new THREE.MeshBasicMaterial({ color: 0x000000, shading: THREE.FlatShading, wireframe: true, wireframeLinewidth: 2, transparent: true })
					];

					if (model !== null)
						scene.remove(model);
					model = new THREE.SceneUtils.createMultiMaterialObject(geometry, materials);
					scene.add(model);

					render();
				}
				var t0 = performance.now();
				eval(compiledCode);
				var t1 = performance.now();
				console.log("Time: ", (t1-t0)/1000.0);
			}

			function init()
			{
				scene = new THREE.Scene();

				camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 100 );
				camera.position.set(10, 10, 10);
				camera.lookAt(new THREE.Vector3(0, 0, 0));

				renderer = new THREE.WebGLRenderer({ antialias: true });
				renderer.setClearColor(new THREE.Color(0.2, 0.2, 0.2), 1.0);
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );

				var amblight = new THREE.AmbientLight(new THREE.Color(.3, .3, .3).getHex());
				var dirlight = new THREE.DirectionalLight(0xffffff, 1.0);
				dirlight.position.set(-1, 1, 1);
				scene.add(amblight);
				scene.add(dirlight);

				controls = new THREE.OrbitControls( camera );
				controls.damping = 0.2;
				controls.addEventListener( 'change', render );

				gui = new dat.GUI();
				settings = 
				{
					regenerate: webppl_generate
				}
				gui.add(settings, "regenerate");

				window.addEventListener( 'resize', onWindowResize, false );
				animate();

				// var editor = CodeMirror.fromTextArea(document.getElementById("code"),
				// {
				// 	lineNumbers: true,
				// 	matchBrackets: true,
				// 	autoCloseBrackets: true
				// });

				// Add purely-functional merge/combine to THREE geometry objects.
				THREE.Geometry.prototype.combine = function(other)
				{
					if (other !== null)
					{
						var g = this.clone();
						g.merge(other);
						return g;
					}
					else return this;
				}

				// Any other 'standard' stuff that proc mods will need but that can't go through
				//    the WebPPL compiler.
				window.S = {
					new: function(ctor)
					{
						var newobj = Object.create(ctor.prototype);
						ctor.apply(newobj, Array.prototype.slice.call(arguments, 1));
						return newobj;
					}
				};

				// ------------------------------------------------

				$.get("model.wppl", webppl_compile);
			}

			init();
			render();
		</script>
	</body>
</html>



